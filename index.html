<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Microondas Timer OCR</title>
  <script src="libs/tesseract/tesseract.min.js"></script>
  <style>
    body { margin:0; font-family: system-ui; background: #111; color: #fff; text-align: center; }
    #video { width: 100%; max-width: 500px; border: 4px solid #00ff00; border-radius: 16px; margin: 20px auto; display: block; }
    #canvas { display: none; }
    #timer { font-size: 4rem; margin: 20px; }
    button { padding: 16px 32px; font-size: 1.2rem; background: #00ff00; border: none; border-radius: 50px; margin: 10px; }
    .hidden { display: none; }
    #status { font-size: 1.2rem; color: #0f0; }
  </style>
</head>
<body>
  <h1>üìü Microondas Timer OCR</h1>
  <p>Aponta pro visor do micro-ondas!</p>
  <video id="video" playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="timer">00:00</div>
  <button id="startBtn">üé• Ativar C√¢mera</button>
  <button id="stopBtn" class="hidden">‚èπ Parar</button>
  <div id="status">Toque em Ativar C√¢mera</div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const timerDisplay = document.getElementById('timer');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');

    let stream = null;
    let timerInterval = null;
    let secondsLeft = 0;
    let worker = null;
    let ocrInterval = null;

    // Iniciar c√¢mera
    startBtn.onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      video.play();
      startBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
      status.textContent = "Lendo visor...";
      startOCR();
    };

    stopBtn.onclick = async () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
      if (worker) {
        await worker.terminate();
        worker = null;
      }
      if (ocrInterval) {
        clearInterval(ocrInterval);
        ocrInterval = null;
      }
      clearInterval(timerInterval);
      video.srcObject = null;
      startBtn.classList.remove('hidden');
      stopBtn.classList.add('hidden');
      timerDisplay.textContent = "00:00";
      status.textContent = "Parado";
    };

    // OCR com Tesseract
    async function startOCR() {
      if (worker) {
        await worker.terminate();
      }

      worker = await Tesseract.createWorker(['eng'], {
        workerPath: 'libs/tesseract/worker.min.js',
        corePath: 'libs/tesseract/tesseract-core.wasm.js',
        langPath: 'libs/tesseract/lang/',
        cachePath: 'libs/tesseract/lang/'
      });

      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({
        tessedit_char_whitelist: '0123456789:.',
      });

      if (ocrInterval) clearInterval(ocrInterval);

      ocrInterval = setInterval(async () => {
        if (!video.videoWidth) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        const result = await worker.recognize(canvas);
        const rawText = result.data.text.replace(/\s+/g, '');
        let mins = 0;
        let secs = 0;

        const colonMatch = rawText.match(/(\d{1,2})[:.](\d{2})/);

        if (colonMatch) {
          mins = parseInt(colonMatch[1], 10) || 0;
          secs = parseInt(colonMatch[2], 10) || 0;
        } else {
          const digitsOnly = rawText.replace(/\D/g, '');

          if (digitsOnly.length >= 2) {
            if (digitsOnly.length >= 4) {
              const trimmed = digitsOnly.slice(-4);
              mins = parseInt(trimmed.slice(0, -2), 10) || 0;
              secs = parseInt(trimmed.slice(-2), 10) || 0;
            } else if (digitsOnly.length === 3) {
              mins = parseInt(digitsOnly.slice(0, 1), 10) || 0;
              secs = parseInt(digitsOnly.slice(1), 10) || 0;
            } else {
              secs = parseInt(digitsOnly, 10) || 0;
            }
          }
        }

        if (secs >= 60) {
          mins += Math.floor(secs / 60);
          secs = secs % 60;
        }

        const totalSeconds = mins * 60 + secs;
        if (totalSeconds > 0 && totalSeconds < 3600) { // m√°ximo 1h
          if (secondsLeft !== totalSeconds) {
            secondsLeft = totalSeconds;
            startTimer();
            status.textContent = `Timer detectado: ${mins}:${secs.toString().padStart(2,'0')}`;
          }
        }
      }, 2000); // a cada 2s
    }

    // Timer
    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (secondsLeft <= 0) {
          clearInterval(timerInterval);
          timerDisplay.textContent = "ACABOU!";
          status.textContent = "Tempo esgotado!";
          playAlarm();
          return;
        }
        secondsLeft--;
        const m = Math.floor(secondsLeft / 60);
        const s = secondsLeft % 60;
        timerDisplay.textContent = `${m}:${s.toString().padStart(2,'0')}`;
      }, 1000);
    }

    // Alarme + vibra√ß√£o + notifica√ß√£o
    function playAlarm() {
      // Som (funciona mesmo com tela bloqueada se j√° interagiu antes)
      const audio = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3");
      audio.loop = true;
      audio.play().catch(() => {});
      
      // Vibrar (s√≥ Android)
      if (navigator.vibrate) {
        navigator.vibrate([1000, 500, 1000, 500, 1000]);
      }

      // Notifica√ß√£o (permiss√£o)
      if (Notification.permission === "granted") {
        new Notification("Microondas acabou!", { body: "Corre antes que queime!", icon: "https://cdn-icons-png.flaticon.com/512/2303/2303043.png" });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission();
      }

      setTimeout(() => audio.pause(), 30000); // para ap√≥s 30s
    }
  </script>
</body>
</html>